<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <!-- NEW: Calendar and Table Styles -->
  <style>
    /* Re-using some of your root variables if they exist in style.css */
    :root {
      --card: #fff;
      --shadow: 0 4px 12px rgba(0,0,0,0.05);
      --accent: #ff6b35;
      --text-color: #333;
      --bg-color: #f4f7f6;
    }
    
    /* Dark mode adjustments (if your style.css has them) */
    body.dark {
      --card: #2c2c2c;
      --text-color: #eee;
      --bg-color: #1a1a1a;
    }
    
    body {
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin: 40px 0;
    }
    
    .stat-card {
      background: var(--card);
      padding: 25px;
      border-radius: 16px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    
    .stat-card h3 {
        margin-top: 10px;
        font-size: 1.2em;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .stat-card p {
        font-size: 36px;
        color: var(--accent);
        font-weight: 700;
        margin: 5px 0 0 0;
    }
    
    .dashboard-section {
        background: var(--card);
        border-radius: 16px;
        padding: 25px;
        box-shadow: var(--shadow);
        margin-bottom: 25px;
    }
    
    .dashboard-section h2 {
        text-align: center;
        font-size: 28px;
        color: var(--accent);
        margin-top: 0;
        margin-bottom: 25px;
    }

    /* Calendar Styles */
    .calendar-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .calendar-nav button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2em;
      transition: background 0.3s;
    }
    
    .calendar-nav button:hover {
      background: #e05a2e;
    }
    
    .calendar-nav h3 {
      font-size: 1.8em;
      color: var(--text-color);
      margin: 0;
    }
    
    #calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }
    
    .calendar-header, .calendar-day {
      background: var(--bg-color);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
    }
    
    .calendar-header {
      font-weight: 700;
      color: var(--accent);
    }
    
    .calendar-day {
      min-height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-size: 0.9em;
      color: var(--text-color);
      position: relative;
    }
    
    .calendar-day.empty {
      background: transparent;
    }
    
    .day-number {
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    
    .day-joins {
      background: #28a745;
      color: white;
      font-size: 0.8em;
      padding: 3px 8px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
    }
    
    .day-joins:hover {
        background: #218838;
    }

    /* User Table Styles */
    #user-table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text-color);
    }
    
    #user-table th, #user-table td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--bg-color);
      text-align: left;
    }
    
    #user-table th {
      background: var(--bg-color);
      color: var(--accent);
    }
    
    #user-table tr:hover {
        background-color: var(--bg-color);
    }

    /* Modal Styles */
    #day-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }
    
    #modal-content {
        background: var(--card);
        padding: 30px;
        border-radius: 16px;
        min-width: 300px;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    #modal-content h3 {
        margin-top: 0;
        color: var(--accent);
    }
    
    #modal-users-list {
        list-style: none;
        padding-left: 0;
    }
    
    #modal-users-list li {
        padding: 8px 0;
        border-bottom: 1px solid var(--bg-color);
    }
    
    #modal-close {
        float: right;
        font-size: 1.5em;
        cursor: pointer;
        font-weight: 700;
    }

  </style>
</head>
<body>
  <div class="glacier-bg"></div>
  <div class="snow-container"></div>
  <header>
    <div class="logo"><span>Glacio</span>Live</div>
    <nav><a href="index.html">Home</a><a href="dashboard.html">Dashboard</a><a href="about.html">About</a></nav>
    <div class="header-right">
      <div class="clock" id="clock">00:00 AM</div>
      <!-- Assuming modeToggle exists in your script.js -->
      <label class="toggle-switch"><input type="checkbox" id="modeToggle"><span class="slider"></span></label>
    </div>
  </header>

  <div class="container" style="padding:40px 20px">
    <h1 style="text-align:center;color:var(--accent);font-size:42px">Admin Dashboard</h1>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Alerts</h3>
        <p id="alerts">8</p>
      </div>
      <div class="stat-card">
        <h3>Total Users</h3>
        <p id="total-users-count">0</p>
      </div>
    </div>
    
    <!-- Calendar Section -->
    <div class="dashboard-section">
        <h2>Join Calendar</h2>
        <div class="calendar-nav">
            <button id="prev-month">◄</button>
            <h3 id="month-year"></h3>
            <button id="next-month">►</button>
        </div>
        <div id="calendar-grid"></div>
    </div>
    
    <!-- User List Section -->
    <div class="dashboard-section">
        <h2>All Users</h2>
        <table id="user-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Contact</th>
                    <th>Joined On</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <!-- User rows will be injected here -->
            </tbody>
        </table>
    </div>

  </div>
  
  <!-- Day Modal -->
  <div id="day-modal">
      <div id="modal-content">
          <span id="modal-close">&times;</span>
          <h3 id="modal-date"></h3>
          <ul id="modal-users-list"></ul>
      </div>
  </div>

  <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-water-sci-fi-click-1055.mp3"></audio>
  
  <!-- Load your original script for clocks, etc. -->
  <script src="script.js"></script>

  <!-- NEW: Firebase Dashboard Script -->
  <script type="module">
    // Import Firebase services
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      orderBy, 
      getDocs 
    } from "https.www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    // Your Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBt1Ats_Y4epVTioinUuDB_AfQUFanHtU0",
      authDomain: "glaciolive-fe6ea.firebaseapp.com",
      projectId: "glaciolive-fe6ea",
      storageBucket: "glaciolive-fe6ea.firebasestorage.app",
      messagingSenderId: "562979922381",
      appId: "1:562979922381:web:7c6686faa1a7181880e484",
      measurementId: "G-ZJCNG5LTS0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- State Variables ---
    let joinData = new Map(); // Stores join data: "YYYY-M-D" -> [user, user]
    let currentDate = new Date();
    
    // --- UI Elements ---
    const totalUsersCount = document.getElementById('total-users-count');
    const userTableBody = document.getElementById('user-table-body');
    const calendarGrid = document.getElementById('calendar-grid');
    const monthYearDisplay = document.getElementById('month-year');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const dayModal = document.getElementById('day-modal');
    const modalClose = document.getElementById('modal-close');
    const modalDate = document.getElementById('modal-date');
    const modalUsersList = document.getElementById('modal-users-list');

    // --- Auth Check ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is logged in, load the dashboard data
        loadDashboardData();
      } else {
        // User is not logged in, redirect to login
        window.location.href = "login.html";
      }
    });

    // --- Data Loading ---
    async function loadDashboardData() {
      const usersRef = collection(db, "users");
      const q = query(usersRef, orderBy("joinDate", "desc"));
      
      const snapshot = await getDocs(q);
      
      // Reset data
      joinData.clear();
      let allUsers = [];

      snapshot.forEach(doc => {
        const user = doc.data();
        if (user.joinDate) { // Only process users with a joinDate
            allUsers.push(user);
            const date = user.joinDate.toDate();
            // Use a simple key for the map
            const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`; 
            
            if (!joinData.has(dateKey)) {
                joinData.set(dateKey, []);
            }
            joinData.get(dateKey).push(user);
        }
      });
      
      // 1. Update Total Users
      totalUsersCount.textContent = snapshot.size;
      
      // 2. Render User Table
      renderUserTable(allUsers);
      
      // 3. Render Calendar
      renderCalendar();
    }

    // --- Render Functions ---
    
    function renderUserTable(users) {
      userTableBody.innerHTML = ''; // Clear existing table
      for (const user of users) {
        const tr = document.createElement('tr');
        
        const name = user.displayName || 'N/A';
        const contact = user.email || user.phoneNumber || 'N/A';
        const joinDate = user.joinDate ? user.joinDate.toDate().toLocaleDateString() : 'N/A';
        
        tr.innerHTML = `
          <td>${name}</td>
          <td>${contact}</td>
          <td>${joinDate}</td>
        `;
        userTableBody.appendChild(tr);
      }
    }

    function renderCalendar() {
      calendarGrid.innerHTML = ''; // Clear grid
      
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      
      monthYearDisplay.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // Add day headers
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      for (const day of days) {
          const headerEl = document.createElement('div');
          headerEl.classList.add('calendar-header');
          headerEl.textContent = day;
          calendarGrid.appendChild(headerEl);
      }
      
      // Add empty cells for offset
      for (let i = 0; i < firstDay; i++) {
          const emptyEl = document.createElement('div');
          emptyEl.classList.add('calendar-day', 'empty');
          calendarGrid.appendChild(emptyEl);
      }
      
      // Add day cells
      for (let day = 1; day <= daysInMonth; day++) {
          const dayEl = document.createElement('div');
          dayEl.classList.add('calendar-day');
          
          const dayNumber = document.createElement('div');
          dayNumber.classList.add('day-number');
          dayNumber.textContent = day;
          dayEl.appendChild(dayNumber);
          
          // Check if anyone joined this day
          const dateKey = `${year}-${month}-${day}`;
          if (joinData.has(dateKey)) {
              const usersToday = joinData.get(dateKey);
              const joinsEl = document.createElement('div');
              joinsEl.classList.add('day-joins');
              joinsEl.textContent = `${usersToday.length} Joined`;
              
              // Show modal on click
              joinsEl.onclick = () => showDayModal(usersToday, new Date(year, month, day));
              
              dayEl.appendChild(joinsEl);
          }
          
          calendarGrid.appendChild(dayEl);
      }
    }
    
    // --- Modal Functions ---
    
    function showDayModal(users, date) {
        modalDate.textContent = `Users who joined on ${date.toLocaleDateString()}`;
        modalUsersList.innerHTML = ''; // Clear list
        
        for (const user of users) {
            const li = document.createElement('li');
            li.textContent = user.displayName || user.email || user.phoneNumber;
            modalUsersList.appendChild(li);
        }
        
        dayModal.style.display = 'flex';
    }
    
    function hideDayModal() {
        dayModal.style.display = 'none';
    }

    // --- Event Listeners ---
    prevMonthBtn.onclick = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    };
    
    nextMonthBtn.onclick = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    };
    
    modalClose.onclick = hideDayModal;
    dayModal.onclick = (e) => {
        if (e.target === dayModal) {
            hideDayModal();
        }
    };
    
    // Keep your other script running (like alerts)
    // Note: I'm replacing your random "subs" counter with the real one.
    setInterval(() => {
      document.getElementById('alerts').textContent = 8 + Math.floor(Math.random()*4);
    }, 10000);
    
  </script>
</body>
</html>
